<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agitator Index | Simulation Terminal</title>
    
    <script src="https://cdn.jsdelivr.net/npm/retell-client-js-sdk@latest/dist/index.global.js"></script>

    <style>
        /* --- GLOBAL STYLES --- */
        body {
            background-color: #000;
            color: #fff;
            font-family: 'Courier New', monospace;
            margin: 0;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        /* Background Grid */
        .bg-grid {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: 
                linear-gradient(rgba(0, 255, 65, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 65, 0.05) 1px, transparent 1px);
            background-size: 50px 50px;
            z-index: 1;
        }

        /* --- GATEKEEPER OVERLAY (LOCKED STATE) --- */
        #agitator-gatekeeper {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999;
            display: flex; align-items: center; justify-content: center;
            text-align: center;
        }

        .gate-content {
            position: relative; z-index: 10; max-width: 500px; width: 90%;
            background: #0a0a0a; border: 1px solid #333; padding: 40px;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }

        /* --- SIMULATION UI (UNLOCKED STATE) --- */
        #simulation-ui {
            position: relative; z-index: 5; max-width: 600px; width: 90%;
            text-align: center; display: none; /* Hidden until unlocked */
            padding: 40px; border: 1px solid #00FF41; background: #0a0a0a;
            box-shadow: 0 0 50px rgba(0, 255, 65, 0.1);
        }

        /* --- SHARED COMPONENTS --- */
        .status-bar {
            border-bottom: 1px solid #333; padding-bottom: 20px; margin-bottom: 30px;
            font-size: 12px; color: #666; display: flex; justify-content: space-between;
        }
        .status-green { color: #00FF41; animation: blink 2s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        h1 { font-size: 32px; line-height: 1.2; margin-bottom: 10px; text-transform: uppercase; color: #fff; letter-spacing: -1px; }
        .subhead { color: #888; font-size: 16px; line-height: 1.5; margin-bottom: 40px; }

        /* BUTTONS & INPUTS */
        .btn-group { display: flex; flex-direction: column; gap: 20px; }

        .main-btn, .secondary-btn {
            padding: 20px; font-family: 'Courier New', monospace; font-size: 16px; font-weight: bold;
            cursor: pointer; text-transform: uppercase; letter-spacing: 1px; width: 100%;
            transition: all 0.2s; box-sizing: border-box;
        }

        .main-btn { background: #00FF41; color: #000; border: 1px solid #00FF41; }
        .main-btn:hover { background: #fff; box-shadow: 0 0 30px rgba(0, 255, 65, 0.5); }

        .secondary-btn { background: transparent; color: #00FF41; border: 1px solid #00FF41; }
        .secondary-btn:hover { background: rgba(0, 255, 65, 0.1); }

        .stop-btn { background: transparent; color: #FF3333; border: 1px solid #FF3333; }
        .stop-btn:hover { background: rgba(255, 51, 51, 0.1); box-shadow: 0 0 15px rgba(255, 51, 51, 0.3); }

        input {
            background: #000; border: 1px solid #333; padding: 20px; color: #fff;
            font-family: 'Courier New', monospace; font-size: 16px; text-align: center;
            outline: none; width: 100%; box-sizing: border-box; margin-bottom: 15px;
        }
        input:focus { border-color: #00FF41; }

        .back-link { margin-top: 20px; color: #666; font-size: 12px; cursor: pointer; text-decoration: underline; }
        
        /* VOICE ORB ANIMATION */
        .voice-orb {
            width: 100px; height: 100px; background: #000; border-radius: 50%;
            border: 2px solid #333; margin: 0 auto 30px auto; position: relative;
            display: flex; align-items: center; justify-content: center; font-size: 40px;
        }
        .voice-orb.active {
            border-color: #00FF41; box-shadow: 0 0 30px #00FF41;
            animation: pulse-orb 2s infinite;
        }
        @keyframes pulse-orb { 0% {box-shadow: 0 0 30px #00FF41;} 50% {box-shadow: 0 0 60px #00FF41;} 100% {box-shadow: 0 0 30px #00FF41;} }

        /* Utilities */
        #gate-request, #gate-code, #gate-error { display: none; }
        .scan-line { width: 100%; height: 2px; background: #00FF41; position: absolute; top: 0; left: 0; animation: scan 3s linear infinite; opacity: 0.3; pointer-events: none; }
        @keyframes scan { 0% { top: 0%; opacity: 0; } 50% { opacity: 0.5; } 100% { top: 100%; opacity: 0; } }
        .secure-note { margin-top: 30px; font-size: 10px; color: #444; text-transform: uppercase; }
    </style>
</head>
<body>

    <div class="bg-grid"></div>

    <div id="agitator-gatekeeper">
        <div class="gate-content">
            <div class="scan-line"></div>
            <div class="status-bar">
                <span>PROTOCOL: AGITATOR_INDEX</span>
                <span class="status-green">‚óè SYSTEM LOCKED</span>
            </div>

            <h1>The Flight Simulator<br>For Enterprise Sales.</h1>
            <p class="subhead">Live Voice AI simulation testing negotiation reflexes.</p>

            <div id="gate-home" class="btn-group">
                <button onclick="gateView('request')" class="main-btn">REQUEST ACCESS</button>
                <button onclick="gateView('code')" class="secondary-btn">I HAVE A CODE</button>
            </div>

            <div id="gate-request">
                <input type="email" id="gate-email" placeholder="ENTER WORK EMAIL">
                <button onclick="gateSubmitRequest()" class="main-btn">JOIN WAITLIST</button>
                <div onclick="gateView('home')" class="back-link">[ ‚Üê BACK ]</div>
            </div>

            <div id="gate-code">
                <input type="text" id="gate-input" placeholder="ENTER CODE" style="text-transform:uppercase; letter-spacing:2px;">
                <button onclick="gateCheck()" class="main-btn" style="background:#fff; color:#000;">VERIFY CODE</button>
                <div id="gate-error" style="color:#FF3333; margin-top:15px; font-size:14px; font-weight:bold;">‚ùå ACCESS DENIED</div>
                <div onclick="gateView('home')" class="back-link">[ ‚Üê BACK ]</div>
            </div>

            <div class="secure-note">Restricted Access // Agitator Protocol V3.3</div>
        </div>
    </div>


    <div id="simulation-ui">
        <div class="status-bar">
            <span>AGITATOR INDEX: ACTIVE</span>
            <span class="status-green">‚óè CONNECTED</span>
        </div>

        <div id="orb" class="voice-orb">
            <div class="mic-icon">üéôÔ∏è</div>
        </div>

        <h1 id="sim-status">Simulation Ready</h1>
        <p class="subhead">
            Your objective: <strong>Survive the pressure.</strong><br>
            Handle the objections. Do not fold.
        </p>

        <button id="start-call-btn" class="main-btn" onclick="toggleCall()">INITIALIZE UPLINK</button>
        <button id="end-call-btn" class="stop-btn" style="display:none;" onclick="toggleCall()">TERMINATE UPLINK</button>

        <div class="secure-note">RECORDING ACTIVE // SESSION ID: <span id="sess-id">PENDING</span></div>
    </div>


    <script>
        // --- GATEKEEPER CONFIGURATION ---
        const VALID_CODES = ['AGITATOR', 'MONEYBALL', 'VIP2026', 'BETA']; 
        
        // --- RETELL AI CLIENT ---
        const retellWebClient = new retellClientSdk.RetellWebClient();
        let isCalling = false;

        // --- GATE UI LOGIC ---
        function gateView(view) {
            document.getElementById('gate-home').style.display = 'none';
            document.getElementById('gate-request').style.display = 'none';
            document.getElementById('gate-code').style.display = 'none';
            document.getElementById('gate-error').style.display = 'none';
            
            if(view === 'home') document.getElementById('gate-home').style.display = 'flex';
            if(view === 'request') {
                document.getElementById('gate-request').style.display = 'block';
                document.getElementById('gate-email').focus();
            }
            if(view === 'code') {
                document.getElementById('gate-code').style.display = 'block';
                document.getElementById('gate-input').focus();
            }
        }

        function gateSubmitRequest() {
            const btn = document.querySelector('#gate-request button');
            const email = document.getElementById('gate-email').value;
            if(!email) return;
            
            btn.innerText = "ADDING TO QUEUE...";
            setTimeout(() => {
                alert("You have been added to the priority list.");
                window.location.reload(); 
            }, 1000);
        }

        function gateCheck() {
            const input = document.getElementById('gate-input');
            const code = input.value.trim().toUpperCase();
            
            if(VALID_CODES.includes(code)) {
                // SUCCESS: UNLOCK
                const gate = document.getElementById('agitator-gatekeeper');
                gate.style.transition = "opacity 0.5s ease";
                gate.style.opacity = "0";
                setTimeout(() => {
                    gate.style.display = "none"; // Remove Gate
                    document.getElementById('simulation-ui').style.display = "block"; // Show App
                    document.getElementById('sess-id').innerText = "SMB-" + Math.floor(Math.random()*10000);
                }, 500);
            } else {
                // FAIL
                document.getElementById('gate-error').style.display = 'block';
                input.style.borderColor = '#FF3333';
                setTimeout(() => { input.style.borderColor = '#333'; }, 2000);
            }
        }

        // --- RETELL AI LOGIC ---
        
        // Listen for call updates from Retell
        retellWebClient.on("call_started", () => {
            console.log("Call started");
            updateUIState(true);
        });

        retellWebClient.on("call_ended", () => {
            console.log("Call ended");
            isCalling = false;
            updateUIState(false);
        });
        
        retellWebClient.on("error", (error) => {
            console.error("An error occurred:", error);
            alert("Connection Error: " + error.message);
            isCalling = false;
            updateUIState(false);
        });

        async function toggleCall() {
            const startBtn = document.getElementById('start-call-btn');
            
            if (isCalling) {
                // STOP THE CALL
                retellWebClient.stopCall();
                isCalling = false;
                updateUIState(false);
            } else {
                // START THE CALL
                isCalling = true;
                startBtn.innerText = "ESTABLISHING UPLINK...";
                
                try {
                    // 1. Get Token from your local API
                    // Note: We assume your file api/register-call.js is accessible via /api/register-call
                    const response = await fetch("/api/register-call", {
                        method: "POST", // Retell usually expects a POST to create the call
                        headers: { "Content-Type": "application/json" }
                        // If your API needs an agent ID in the body, add it here:
                        // body: JSON.stringify({ agent_id: "YOUR_AGENT_ID" }) 
                    });

                    if (!response.ok) throw new Error("Failed to get access token from backend");

                    const data = await response.json();
                    
                    // 2. Start the call with the access token
                    // We assume the API returns { access_token: "..." }
                    await retellWebClient.startCall({
                        accessToken: data.access_token, 
                    });

                } catch (err) {
                    console.error("Start call failed:", err);
                    alert("Uplink Failed: " + err.message);
                    isCalling = false;
                    updateUIState(false);
                }
            }
        }

        function updateUIState(active) {
            const startBtn = document.getElementById('start-call-btn');
            const endBtn = document.getElementById('end-call-btn');
            const orb = document.getElementById('orb');
            const status = document.getElementById('sim-status');

            if (active) {
                startBtn.style.display = 'none';
                endBtn.style.display = 'block';
                orb.classList.add('active');
                status.innerText = "Call in Progress...";
            } else {
                startBtn.style.display = 'block';
                startBtn.innerText = "INITIALIZE UPLINK";
                endBtn.style.display = 'none';
                orb.classList.remove('active');
                status.innerText = "Simulation Ready";
            }
        }
    </script>

</body>
</html>
